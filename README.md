Docker
================================================================================

Quick Guide
--------------------------------------------------------------------------------
`docker ps -a`

`docker images`

`docker rmi <image-id>`

`docker rm <container-id>`

`docker logs <container-id>`

`docker volume ls`

[Volume mapping](https://docs.docker.com/storage/volumes/)
--------------------------------------------------------------------------------
Volumes are the preferred mechanism for persisting data generated by and used by Docker containers.
While bind mounts are dependent on the directory structure of the host machine, volumes are completely managed by Docker.
Volumes have several advantages over bind mounts:
- Volumes are easier to back up or migrate than bind mounts.
- You can manage volumes using Docker CLI commands or the Docker API.
- Volumes work on both Linux and Windows containers.
- Volumes can be more safely shared among multiple containers.
- Volume drivers let you store volumes on remote hosts or cloud providers, to encrypt the contents of volumes, or to add other functionality.

New volumes can have their content pre-populated by a container.
In addition, volumes are often a better choice than persisting data in a container’s writable layer, because a volume does not increase the size of the containers using it, and the volume’s contents exist outside the lifecycle of a given container.

The biggest difference is that the -v syntax combines all the options together in one field, while the --mount syntax separates them.

If you need to specify volume driver options, you must use --mount.

`-v` or `--volume`: 
Consists of three fields, separated by colon characters (:). 
- name of the volume, and is unique on a given host machine. For anonymous volumes, the first field is omitted.
- path where the file or directory are mounted in the container.
- (optional 3rd field), comma-separated list of options, such as `ro`.

`--mount`:
Consists of multiple key-value pairs, separated by commas and each consisting of a <key>=<value> tuple.
The `--mount` syntax is more verbose han `-v` or `--volume`, but the order of the keys is not significant, and the value of the flag is easier to understand.
- The `type` of the mount, which can be bind, volume, or tmpfs.
- The `source` of the mount. For named volumes, this is the name of the volume. For anonymous volumes, this field is omitted. May be specified as source or src.
The destination takes as its value the path where the file or directory is mounted in the container. May be specified as destination, dst, or target.
- The `readonly` option, if present, causes the bind mount to be mounted into the container as read-only.
- The `volume-opt` option, which can be specified more than once, takes a key-value pair consisting of the option name and its value.

Create a volume:
```bash
$ docker volume create my-vol
```

List volumes:
```bash
$ docker volume ls
```
local               my-vol

Inspect a volume:
```bash
$ docker volume inspect my-vol
```
[
    {
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/my-vol/_data",
        "Name": "my-vol",
        "Options": {},
        "Scope": "local"
    }
]

Remove a volume:
```bash
$ docker volume rm my-vol
```

Start a container with a volume:
If you start a container with a volume that does not yet exist, Docker creates the volume for you.
The following example mounts the volume `myvol2` into `/app/` in the container.

The `-v` and `--mount` examples below produce the same result.
You can’t run them both unless you remove the `devtest` container and the `myvol2` volume after running the first one.

Using `--mount`
```bash
$ docker run -d \
  --name devtest \
  --mount source=myvol2,target=/app \
  nginx:latest
```

Using `-v`
```bash
$ docker run -d \
  --name devtest \
  -v myvol2:/app \
  nginx:latest
```

Use docker inspect devtest to verify that the volume was created and mounted correctly. Look for the Mounts section:
```
"Mounts": [
    {
        "Type": "volume",
        "Name": "myvol2",
        "Source": "/var/lib/docker/volumes/myvol2/_data",
        "Destination": "/app",
        "Driver": "local",
        "Mode": "",
        "RW": true,
        "Propagation": ""
    }
],
```

Remove all volumes
To remove all unused volumes and free up space:
```bash
$ docker volume prune
```

```bash
$ docker run -d \
  --name alpinetest \
  -v alpinevol:$HOME/alpinevol \
  alpine:latest
```

Docker for Beginners
================================================================================
https://www.youtube.com/watch?v=zJ6WbK9zFpI

tag
--------------------------------------------------------------------------------
- Specified after a colon.
- e.g. '4.0' is a tag for redis
`docker run redis:4.0`
- Image can have multiple long and short tags associated with it.

### -i flag
- Interactive mode

### -t flag
- Terminal mode

### -p flag
- PORT mapping
- Every Docker container gets IP assigned by default.
- IP is only available on Docker Host.
- e.g. map port 80 on host to port 5000 in the Docker container.
`docker run -p 80:5000 my-sample/my-webapp`
- You can't map to the same host port multiple times (failed: port is already allocated.)
- You can map multiple host ports to a single Docker container port
e.g. `docker run -p 3306:3306 mysql && docker run -p 8306:3306 mysql`

Volume
--------------------------------------------------------------------------------
- By default data is only persisted while container is running.
- e.g. `/var/lbi/mysql`
- Docker container has it's own isolated file system.
- When you delete the container, you delete all the data witin it too.
- To persist date you must map a directory one the host to the Docker container.
`docker run -v /opt/datadir:/var/lib/mysql mysql`

https://nickjanetakis.com/blog/docker-tip-28-named-volumes-vs-path-based-volumes

Environment Variables
--------------------------------------------------------------------------------
- Use `-e` option
`docker run -e APP_COLOR=blue simple-webapp-color`
- Use Docker inspect to see a list of the enviornment variables on a running container.
`docker inspect <image-id>`

Docker Images
--------------------------------------------------------------------------------
47:22
- Create your own image

List layered architecture and respective sizes
`docker history <image-id>`

Docker is meant to run a task then exit and die.

`CMD`
--------------------------------------------------------------------------------
- Defines program that will run when Docker is started
- Use command param1 or ["command", "param1"] format
- You can override the default command by passing a command to the `run` command
- Command line arguments replace the CMD
`docker run ubuntu [COMMAND]`
`docker run ubuntu sleep 5`

e.g. ubuntu-sleeper
```Dockerfile
FROM Ubuntu

CMD sleep 5
```
run Dockerfile
`docker run ubuntu-sleeper sleep 10`

`ENTRYPOINT`
--------------------------------------------------------------------------------
- Specifies the program to run at startup
- Command line arguments get appended to entrypoint

e.g. ubuntu-sleeper
```Dockerfile
FROM Ubuntu

ENTRYPOINT ["sleep"]
```
run Dockerfile
`docker run ubuntu-sleeper 10`

- Default command, add CMD after ENTRYPOINT
e.g. ubuntu-sleeper
```Dockerfile
FROM Ubuntu

ENTRYPOINT ["sleep"]

CMD["5"]
```
- Always specify ENTRYPOINT and CMD in jason format

Override the ENTRYPOINT command
`docker run --entrypoint sleep2.0 ubuntu-sleeper 10`

Networking
--------------------------------------------------------------------------------
58:30
Default networks:
- Bridge
  - Private internal network with its own IP (usually in 172.17 series)
  - Used by default
  `docker run ubuntu`
- none
  - Isolated network
  `docker run ubuntu --network=none`
- host
  - Same port will be available in Docker container as on host
  `docker run ubuntu --network=host`

Create multiple instances of a bridge network
```bash
docker network create \
  --driver=bridge \
  --subnet=182.18.0.0/16
  custom-isolated-network
```

`docker network ls`

Embedded DNS
- Use container name to find each container's IP
- DNS server IP 172.0.0.11

Storage
--------------------------------------------------------------------------------
File system
```
/var/lib/docker
  /aufs
  /containers
  /image
  /volumes
```

Compose
--------------------------------------------------------------------------------
116:00
- Evolved over time so it now has 3 versions.
`version 3` is latest

`docker-compose.yml`
- Uses yaml files for configuration

`docker compose up`

- You can specify to use an `image: some-image` or `build: ./some-path`

